apiVersion: v1
kind: Pod
metadata:
  name: python-sandbox-{session-id}
  labels:
    app: python-sandbox
    session: {session-id}
    component: code-executor
spec:
  restartPolicy: Never
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    fsGroup: 1000
  containers:
  - name: python-sandbox
    image: pandasai-sandbox:latest
    resources:
      limits:
        memory: "512Mi"
        cpu: "500m"
        ephemeral-storage: "1Gi"
      requests:
        memory: "256Mi"  
        cpu: "250m"
    securityContext:
      allowPrivilegeEscalation: false
      readOnlyRootFilesystem: false
      capabilities:
        drop:
        - ALL
    env:
    - name: PYTHONUNBUFFERED
      value: "1"
    - name: SESSION_ID
      value: "{session-id}"
    volumeMounts:
    - name: temp-volume
      mountPath: /tmp
    - name: workspace
      mountPath: /workspace
    ports:
    - containerPort: 8080
      name: api
    livenessProbe:
      httpGet:
        path: /health
        port: 8080
      initialDelaySeconds: 5
      periodSeconds: 10
      failureThreshold: 3
    readinessProbe:
      httpGet:
        path: /ready
        port: 8080
      initialDelaySeconds: 2
      periodSeconds: 5
  volumes:
  - name: temp-volume
    emptyDir:
      sizeLimit: 100Mi
  - name: workspace
    emptyDir:
      sizeLimit: 500Mi
  nodeSelector:
    workload-type: sandbox
  tolerations:
  - key: "sandbox"
    operator: "Equal"
    value: "true"
    effect: "NoSchedule"
---
apiVersion: v1
kind: Service
metadata:
  name: python-sandbox-{session-id}
  labels:
    app: python-sandbox
    session: {session-id}
spec:
  selector:
    app: python-sandbox
    session: {session-id}
  ports:
  - port: 8080
    targetPort: 8080
    name: api
  type: ClusterIP